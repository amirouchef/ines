<script>
    let score = 0;
    const ERROR_SLIDES = [8, 15, 22];

    // Récupération d'un paramètre d'URL
    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    // Met à jour l'affichage + enregistre le score
    function updateDisplay() {
        const displayElement = document.getElementById('scoreDisplay');
        displayElement.textContent = score;
        localStorage.setItem('dentalQuizScore', score);

        // Animation pulse
        displayElement.classList.remove('pulse');
        void displayElement.offsetWidth; // Force reflow
        displayElement.classList.add('pulse');
    }

    // Affichage initial (sans modifier le score)
    function initDisplay() {
        const displayElement = document.getElementById('scoreDisplay');
        displayElement.textContent = score;
    }

    // Logique liée au numéro de diapo
    function applySlideLogic() {
        const slideParam = getQueryParam('slide');
        const type = getQueryParam('type'); // "normal", "error" ou "none"

        if (!slideParam) return;

        const slide = parseInt(slideParam, 10);
        if (isNaN(slide)) return;

        let oldScore = score;

        if (type === 'error' && ERROR_SLIDES.includes(slide)) {
            // À chaque fois qu'on arrive sur 8, 15 ou 22 → -1
            score -= 1;
        } else if (type === 'normal') {
            // On n'incrémente QUE si on atteint une diapo au numéro plus grand qu'avant
            let maxSlide = parseInt(localStorage.getItem('dentalQuizMaxSlide') || '0', 10);

            if (slide > maxSlide) {
                score += 1; // +1 pour cette nouvelle étape atteinte
                maxSlide = slide;
                localStorage.setItem('dentalQuizMaxSlide', String(maxSlide));
            }
        }

        if (score !== oldScore) {
            updateDisplay();
        }
    }

    // Chargement initial
    window.onload = function() {
        const savedScore = localStorage.getItem('dentalQuizScore');
        if (savedScore !== null) {
            score = parseInt(savedScore, 10) || 0;
        }
        initDisplay();
        applySlideLogic();
    };

    // Boutons manuels (tu peux les laisser pour debug ou les enlever du HTML)
    function addPoint() {
        score += 1;
        updateDisplay();
        flashButton('correct');
    }

    function subtractPoint() {
        score -= 1;
        updateDisplay();
        flashButton('wrong');
    }

    function resetScore() {
        if (confirm('Reset score to 0?')) {
            score = 0;
            localStorage.setItem('dentalQuizMaxSlide', '0');
            updateDisplay();
        }
    }

    function flashButton(type) {
        const btn = type === 'correct' ?
            document.querySelector('.btn-correct') :
            document.querySelector('.btn-wrong');

        if (!btn) return;
        btn.style.transform = 'scale(0.95)';
        setTimeout(() => {
            btn.style.transform = 'scale(1)';
        }, 100);
    }
</script>
